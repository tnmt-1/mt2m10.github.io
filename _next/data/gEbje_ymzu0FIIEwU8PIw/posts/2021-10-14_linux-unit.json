{"pageProps":{"blog":{"id":"2021-10-14_linux-unit","title":"Linuxでユニットファイルを作って自動起動させる","publishedAt":"2021-10-14","body":"<p>PHPのビルトインサーバとNode.js Express アプリケーション用のビルトインサーバのユニットファイルを作成して自動起動できるようにしました。<br>\n凝ったことをしないのであれば、<code>service</code> ファイルを作成するだけでOKなので簡単です。</p>\n<p>実行させるコマンドは以下です。</p>\n<ul>\n<li>PHP\n<ul>\n<li><code>php -S 0.0.0.0:8000 public/index.php -t public</code></li>\n</ul>\n</li>\n<li>Node.js\n<ul>\n<li><code>node ./bin/www</code></li>\n</ul>\n</li>\n</ul>\n<p><code>service</code> ファイルに書くときは、 <code>php</code> コマンドや <code>node</code> コマンドをフルパスで書くと確実に動くので、パスを確認しておきます。</p>\n<pre><code>$ which php\n/usr/bin/php\n$ which node\n~/.nvm/versions/node/v16.11.1/bin/node\n</code></pre>\n<p>確認したら、<code>service</code> ファイルを作ります。ファイル名はなんでもOKです。ここでは<code>php.service</code>、<code>nodejs.service</code>とします。</p>\n<ul>\n<li>/etc/systemd/system/php.service\n<pre><code>[Unit]\nDescription = serve php\n\n[Service]\nExecStart = /usr/bin/php -S 0.0.0.0:8000 public/index.php -t public\nRestart = always\nType = simple\nWorkingDirectory = /home/ec2-user/php-app\nUser = ec2-user\nGroup = ec2-user\n\n[Install]\nWantedBy = multi-user.target\n</code></pre>\n</li>\n<li>/etc/systemd/system/nodejs.service\n<pre><code>[Unit]\nDescription = serve nodejs\n\n[Service]\nExecStart = /home/ec2-user/.nvm/versions/node/v16.11.1/bin/node ./bin/www\nRestart = always\nType = simple\nWorkingDirectory = /home/ec2-user/nodejs-app\nUser = ec2-user\nGroup = ec2-user\n\n[Install]\nWantedBy = multi-user.target\n</code></pre>\n</li>\n</ul>\n<p><code>WorkingDirectory</code> にアプリケーションのルートディレクトリを指定して <code>ExecStart</code> にコマンドを指定します。他の項目については説明できないので各々で調べてください。</p>\n<p>それでは、ビルトインサーバを起動しましょう</p>\n<pre><code>$ sudo systemctl start php\n$ sudo systemctl start nodejs\n</code></pre>\n<p>開始したら状態を確認します。以下のようになっていればOKです。</p>\n<pre><code>$ sudo systemctl status php\n● php.service - serve php\n   Loaded: loaded (/etc/systemd/system/php.service; enabled; vendor preset: disabled)\n   Active: active (running) since Thu 2021-10-14 01:30:20 UTC; 1h 8min ago\n Main PID: 10612 (php)\n   CGroup: /system.slice/php.service\n           └─10612 /usr/bin/php -S 0.0.0.0:8000 public/index.php -t public\n\n$ sudo systemctl status nodejs\n● nodejs.service - serve nodejs\n   Loaded: loaded (/etc/systemd/system/nodejs.service; enabled; vendor preset: disabled)\n   Active: active (running) since Thu 2021-10-14 02:16:43 UTC; 23min ago\n Main PID: 8875 (node)\n   CGroup: /system.slice/nodejs.service\n           └─8875 /home/ec2-user/.nvm/versions/node/v16.11.1/bin/node ./bin/www\n</code></pre>\n<p>自動起動の設定をする場合は、以下コマンドを実行してください。</p>\n<pre><code>$ sudo systemctl enable php\n$ sudo systemctl enable nodejs\n</code></pre>"}},"__N_SSG":true}