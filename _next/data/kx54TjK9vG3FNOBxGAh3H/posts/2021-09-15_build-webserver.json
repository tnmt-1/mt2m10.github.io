{"pageProps":{"blog":{"id":"2021-09-15_build-webserver","title":"Amazon Linux 2 + Apache + Codeigniter4 でのWebサーバ構築","publishedAt":"2021-09-15","body":"<p>Amazon Linux 2 インスタンスに Apache HTTP Server と PHP8 をインストールしてWebサーバを構築します。<br>\nCodeigniter4のソースコードを利用したかったので、それ用に少しアレンジしています。</p>\n<h3 id=\"環境\">環境</h3>\n<ul>\n<li>Amazon Linux 2 (EC2)</li>\n<li>PHP 8.0.8</li>\n<li>Apache HTTP Server 2.4</li>\n<li>Codeigniter 4</li>\n</ul>\n<h3 id=\"手順\">手順</h3>\n<ol>\n<li>\n<p>PHP 8 とApache HTTP Server をインストール</p>\n<pre><code>$ sudo amazon-linux-extras enable php8.0\n$ sudo yum install -y httpd php php-devel php-mysqlnd php-mbstring php-gd php-xml php-opcache php-pecl-zip php-pear php-intl mod_ssl\n</code></pre>\n</li>\n<li>\n<p>Apache HTTP Server を有効化 + 起動</p>\n<pre><code>$ sudo systemctl enable httpd\n$ sudo systemctl start httpd\n</code></pre>\n</li>\n<li>\n<p>ファイルの許可設定<br>\nec2-user を apache グループに追加し、apache ディレクトリの所有権を /var/www グループに付与し、グループへの書き込み権限を割り当てます。</p>\n<pre><code>$ sudo usermod -a -G apache ec2-user\n$ exit\n</code></pre>\n<p>再ログインして、グループが適用されているか確認する。</p>\n<pre><code>$ groups\n</code></pre>\n<p><code>/var/www</code> 配下のグループと所有権を変更する。</p>\n<pre><code>$ sudo chown -R ec2-user:apache /var/www\n$ sudo chmod 2775 /var/www &#x26;&#x26; find /var/www -type d -exec $ sudo chmod 2775 {} \\;\n$ find /var/www -type f -exec sudo chmod 0664 {} \\;\n</code></pre>\n</li>\n<li>\n<p>(オプション) Composer のインストール<br>\n個人的に Composer を使いたかったのでインストールしています。</p>\n<pre><code>$ sudo su -\n\n# php -r \"copy('https://getcomposer.org/installer', 'composer-setup.php');\"\n# php -r \"if (hash_file('sha384', 'composer-setup.php') === '756890a4488ce9024fc62c56153228907f1545c228516cbf63f885e036d37e9a59d27d63f46af1d4d07ee0f76181c7d3') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;\"\n# php composer-setup.php\n# php -r \"unlink('composer-setup.php');\"\n# mv composer.phar /usr/local/bin/composer\n# chmod 777 /usr/local/bin/composer\n</code></pre>\n</li>\n<li>\n<p>SSL/TLS の設定<br>\n自己署名のデジタル証明書を使用して、Amazon Linux 2 で TLS をセットアップしてきます。</p>\n<p>サーバーホスト用の自己署名 X.509 証明書とプライベートキーを生成するためのスクリプトを利用してセットアップします。<br>\n作成された <code>localhost.crt</code> には証明書とキーの両方が含まれています。</p>\n<pre><code># cd /etc/pki/tls/certs\n# ./make-dummy-cert localhost.crt\n</code></pre>\n<p><code>/etc/httpd/conf.d/ssl.conf </code> を編集します。</p>\n<ul>\n<li><code>DocumentRoot \"/var/www/html/public\"</code> を追加</li>\n<li><code>SSLCertificateKeyFile /etc/pki/tls/private/localhost.key</code> をコメントアウト</li>\n</ul>\n<p><code>/etc/httpd/conf.d/vhost.conf</code> を新規追加します（<code>vhost.conf</code> というファイル名でなくてもOK）。</p>\n<pre><code class=\"language-conf\">&#x3C;Directory \"/var/www/html\">\n    AllowOverride All\n&#x3C;/Directory>\n\n&#x3C;VirtualHost *:80>\n    DocumentRoot \"/var/www/html/public\"\n&#x3C;/VirtualHost>\n</code></pre>\n<p>完了したら <code>Apache HTTP Server</code> を再起動します。</p>\n<pre><code># systemctl restart httpd\n# exit\n</code></pre>\n</li>\n<li>\n<p>Codeigniter プロジェクトを作成</p>\n<pre><code>$ cd /var/www/\n$ composer create-project codeigniter4/appstarter html\n</code></pre>\n</li>\n</ol>\n<h3 id=\"参考\">参考</h3>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/ec2-lamp-amazon-linux-2.html\">チュートリアル: Amazon Linux 2 に LAMP ウェブサーバーをインストールする</a></li>\n<li><a href=\"https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/SSL-on-amazon-linux-2.html\">チュートリアル: Amazon Linux 2 に SSL/TLS を設定する</a></li>\n<li><a href=\"https://e-kamo.net/amazon-linux-extras-php8-available\">Amazon Linux 2 の Extras Library に PHP8.0 登場</a></li>\n</ul>"}},"__N_SSG":true}